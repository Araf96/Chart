var app=angular.module("demo",[]),datainput=[],dataconfig=[],sorted_data=[],canvasid="";app.factory("library",function(){return{_$runchart:function(a,t,e){datainput=t,dataconfig=e,canvasid=a;for(var r=0;r<datainput.length;r++)sorted_data[r]=t[r];"funnel"==dataconfig[10].value?_$funnelchart():"bar"==dataconfig[10].value&&_$barchart()}}});var _$funnelchart=function(){var a=document.getElementById(this.canvasid),t=a.getContext("2d"),e=dataconfig[3].value,r=dataconfig[4].value;a.width=e,a.height=r;var u=Number(r),l=Number(e),n=Math.round(.2*l),i=Math.round(.2*u),d=(Math.round(.5*l),Math.round(.8*u)),v=Math.round(.8*l),o=(Math.round(.2*u),(v-n)/(2*datainput.length)),s=(d-i)/datainput.length,f=(v-n)/(2*datainput.length);sorted_data.sort(function(a,t){return parseFloat(t.value)-parseFloat(a.value)});var h=n,g=v,c=i,m=dataconfig[2].value+" "+dataconfig[1].value+" "+dataconfig[0].value;t.font=m;var p=0,b=0;do{var T=h,x=g;0;for(var w=p=0;w<datainput.length;w++){var N=T+Math.round(f/2);x-Math.round(f/2)-N<=t.measureText(datainput[w].status).width+t.measureText(datainput[w].value).width+10&&(h-=o,g+=o,p=1),T+=o,x-=o}}while(0!=p);for(b=0;b<sorted_data.length;b++){var _=0;for(w=0;w<datainput.length;w++)if(sorted_data[b].status==datainput[w].status&&sorted_data[b].value==datainput[w].value){_=w,console.log(_);break}t.beginPath(),t.moveTo(h+b*o,c+_*s+10),t.lineTo(g-b*o,c+_*s+10),t.lineTo(g-b*o-o,c+_*s+s),t.lineTo(h+b*o+o,c+_*s+s),t.lineTo(h+b*o,c+_*s+10),t.fillStyle="#"+Math.random().toString().slice(3,6),t.fill(),t.stroke(),t.closePath(),t.fillStyle=dataconfig[11].value;var y=t.measureText(datainput[_].status).width+t.measureText(datainput[_].value).width;if("left"==dataconfig[6].value){var M=h+b*o+o/2,S=c+_*s+s/2;t.fillText(datainput[_].status+": "+datainput[_].value,M,S+.1*s)}else if("right"==dataconfig[6].value){M=g-b*o-o-y,S=c+_*s+s/2;t.fillText(datainput[_].status+": "+datainput[_].value,M,S+.1*s)}else{M=(h+g)/2,S=c+_*s+s/2;var I=y/2;t.fillText(datainput[_].status+": "+datainput[_].value,M-I,S+.1*s)}}},_$barchart=function(){for(var a,t,i=JSON.parse(JSON.stringify(datainput)),e=JSON.parse(JSON.stringify(dataconfig)),r=e[3].value,u=e[4].value,l=0;l<=1;l++){var n=document.getElementById(this.canvasid);n.width=u,n.height=r;var d=n.getContext("2d");d.clearRect(0,0,u,r),d.fillStyle=e[5].value,d.fillRect(0,0,n.width,n.height),d.fillStyle="black";var v=0,o=0,s=0;d.scale(u/1920,r/1080),d.translate(a,t);for(var f,h=[],g=0,c=0,m=0;m<i.length;m++){var p=e[2].value+" "+e[1].value+" "+e[0].value;d.font=p;var b=i[m].status+"("+i[m].value+")",T=i[m].status;if(d.measureText(T).width>c&&(c=d.measureText(T).width),d.measureText(b).width>v){v=d.measureText(b).width;var x=i[m].status;s=d.measureText(x).width}Number(i[m].value)>o&&(o=Number(i[m].value)),g+=Number(i[m].value)}var w=20;for(m=0;m<i.length;m++){b=i[m].status;var N=c-d.measureText(b).width;d.fillText(b,0+N,w),w+=45}o=o+o+v;var _=Number(e[7].value),y=0,M=0,S=1,I=e[8].value;o>n.width&&(S=o/(1920-v));var $=new Image;$.src=e[9].value,$.onload=function(){for(var a=20,t=M=0;t<i.length;t++){var e=s+15,r=Number(i[t].value);y=r/_/S,y=parseInt(y);for(var u=0;u<y;u++)d.drawImage($,e,M,_,_),e+=_*I;var l=Number(i[t].value)/g*100,n="("+(l=l.toFixed(2))+"%)";d.fillText(n,e,a),e+=d.measureText(n).width;Number(e);M+=45,a+=45}};for(w=20,m=M=0;m<i.length;m++){var F=s+15,J=Number(i[m].value);y=J/_/S,y=parseInt(y);for(var O=0;O<y;O++)F+=_*I;var k=Number(i[m].value)/g*100,B="("+(k=k.toFixed(2))+"%)";F+=d.measureText(B).width;var C=Number(F)+75;h.push(C),M+=45,w+=45}for(var E=0,P=0;P<h.length;P++)E<Number(h[P])&&(E=Number(h[P]));f=M-15,"centerleft"==e[6].value?(a=0,t=(1080-f)/2):"center"==e[6].value?(a=(1920-E)/2,t=(1080-f)/2):"centerright"==e[6].value?(a=1920-E+75,t=(1080-f)/2):"topleft"==e[6].value?t=a=0:"topright"==e[6].value?(a=1920-E+75,t=0):"bottomleft"==e[6].value?(a=0,t=1080-f):"bottomright"==e[6].value&&(a=1920-E+75,t=1080-f)}};